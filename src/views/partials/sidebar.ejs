<nav class="sidebar">
  <div class="sidebar-header">
    <div>
      <div class="logo-content-container">
        <div class="logo-container">
          <img class="logo" src="/images/logo-desamparados.png" alt="Logo cantón desamparados PNG">
          <div class="title-container">
            <h2>Núcleo Desamparados</h2>
            <p>Conectando a la comunidad</p>
          </div>
        </div>
        <button type="button" class="sidebar-toggle-close">
          <i class="bx bx-x-circle"></i>
        </button>
      </div>
    </div>

    <div class="auth-container">
      <% if (user && userAccounts && userAccounts.length > 0) { %>
        <div class="user-profile-dropdown">
          <button id="dropdown-toggle" class="user-profile-dropdown-toggle" type="button">
            <% 
              const activeAccount = userAccounts.find(acc => acc._id.toString() === user._id.toString()) || userAccounts[0];
            %>
            <div class="user-profile">
              <a href="/auth/perfil" class="user-avatar">
                <% if (user.avatarUrl && user.avatarUrl.length > 2) { %>
                  <img src="<%= user.avatarUrl %>" alt="Avatar usuario" />
                <% } else { %>
                  <%= user.avatarUrl || user.initials %>
                <% } %>
              </a>
              <div class="user-info">
                <p class="username" data-fullname="<%= activeAccount.username %>"><%= activeAccount.username %></p>
                <p class="rol"><%= activeAccount.role.charAt(0).toUpperCase() + activeAccount.role.slice(1) %></p>
              </div>
            </div>
            <% if (userAccounts.length > 1) { %>
              <i class="bx bx-caret-down dropdown-arrow"></i>
            <% } %>
          </button>

          <div id="dropdown-menu" class="dropdown-menu oculto">
            <% userAccounts
                .filter(acc => acc._id.toString() !== user._id.toString())
                .forEach(acc => { %>
              <button class="account-switch-btn" data-id="<%= acc._id %>" type="button">
                <div class="user-profile">
                  <a 
                    class="user-avatar <%= acc._id.toString() !== activeAccountId.toString() ? 'disabled-link' : '' %>"
                    <%= acc._id.toString() === activeAccountId.toString() ? 'href="/auth/perfil"' : '' %>
                  >
                    <% if (acc.avatar && acc.avatar.length > 2) { %>
                      <img src="<%= acc.avatar %>" alt="Avatar usuario" />
                    <% } else { %>
                      <%= acc.avatar || acc.initials %>
                    <% } %>
                  </a>
                  <div class="user-info">
                    <p class="username" data-fullname="<%= acc.username %>"><%= acc.username %></p>
                    <p class="rol"><%= acc.role.charAt(0).toUpperCase() + acc.role.slice(1) %></p>
                  </div>
                </div>
              </button>
            <% }) %>
          </div>
        </div>
      <% } else { %>
        <div class="auth-buttons">
          <a href="/auth/inicio-sesion" class="auth-btn" type="button">Iniciar sesión</a>
          <a href="/auth/registrarse" class="auth-btn" type="button">Registrarse</a>
        </div>
      <% } %>
    </div>

    <% if (user && user.role === 'administrador') { %>
        <ul class="sidebar-links-container" id="sidebar-links-admin">
        <li class="sidebar-link">
        <a href="/admin/panel-administrador">
            <i class="bx bxs-dashboard"></i>
            <span>Panel de Administrador</span>
        </a>
        </li>
        <li class="sidebar-link">
        <a href="/form/form-anuncio-evento-noticia">
            <i class="bx bxs-news"></i>
            <span>Nueva noticia o anuncio</span>
        </a>
        </li>
        <li class="sidebar-link">
        <a href="/admin/usuarios">
            <i class="bx bxs-user"></i>
            <span>Usuarios</span>
        </a>
        </li>
        <li class="sidebar-link">
        <a href="/admin/gestion-contenido">
            <i class="bx bx-check-square"></i>
            <span>Aprobación y Moderación</span>
        </a>
        </li>
        <li class="sidebar-link">
        <a href="/admin/tiquetes">
            <i class="bx bx-message-check"></i>
            <span>Tiquetes</span>
        </a>
        </li>
    </ul>
    <% } %>

  <% if (user && user.role === 'emprendedor') { %>
    <ul class="sidebar-links-container" id="sidebar-links-emprendedor">
      <li class="sidebar-link">
        <a href="/emprendedor/mi-emprendimiento/<%= user._id %>">
          <i class="bx bxs-store-alt"></i>
          <span>Mi emprendimiento</span>
        </a>
      </li>
    </ul>
  <% } %>

  <% if (!user || user && user.role != 'emprendedor' && user.role != 'administrador') { %>
    <ul class="sidebar-links-container" id="sidebar-links-general">
      <li class="sidebar-link">
        <a href="/">
          <i class="bx bxs-home"></i>
          <span>Inicio</span>
        </a>
      </li>
    </ul>
  <% } %>


  <% if (!user || user && user.role != 'emprendedor' && user.role != 'administrador') { %>
    <ul class="sidebar-links-container" id="sidebar-links-ciudadano">
      <li class="sidebar-link">
        <a href="/noticias-anuncios-eventos">
          <i class="bx bxs-news"></i>
          <span>Noticias</span>
        </a>
      </li>
      <li class="sidebar-link">
        <a href="/emprendimientos">
          <i class="bx bxs-store"></i>
          <span>Emprendimientos</span>
        </a>
      </li>
      <li class="sidebar-link">
        <a href="/sugerencias">
          <i class="bx bxs-megaphone"></i>
          <span>Quejas y sugerencias</span>
        </a>
      </li>
      <li class="sidebar-link">
        <a href="/horario-buses">
          <i class="bx bxs-bus"></i>
          <span>Horario de Buses</span>
        </a>
      </li>
    </ul>
<% } %>
</nav>
<script src="/js/userAccountFetchAndSwitch.js"></script>