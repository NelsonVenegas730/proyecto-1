<body>
  <main>
    <%- include('../partials/filter-controls', { filterType: 'state' }) %>
    <% if (tickets.length === 0) { %>
      <%- include('../partials/content-not-found', { 
          title: 'No se encontraron tiquetes de soporte', 
          helpText: [
            'Si crees que esto es un error, escribe un ',
            '¿Quieres escribir un nuevo tiquete de soporte?'
          ], 
          tooltip: [
            'tiquete de soporte',
            'tiquete de soporte'
          ],
          href: [
            '/form/form-tiquete',
            '/form/form-tiquete'
          ] 
        }) %>
    <% } else { %>
      <div class="tickets-container">
        <% tickets.forEach(ticket => { %>
          <div class="ticket-element card" 
              data-user-id="<%= ticket.user_id?._id || '' %>" 
              data-ticket-id="<%= ticket._id %>"
          >
            <% if (user && ticket.user_id && ticket.user_id._id == user._id) { %>
              
                <div class="ticket-menu-wrapper">
                    <button class="ticket-menu-btn" aria-label="Opciones">
                        <i class='bx bx-dots-vertical-rounded'></i>
                    </button>

                    <div class="ticket-menu-popup">
                        <button class="ticket-menu-option edit-btn"> 
                            <i class="bx bx-pencil"></i>
                            Editar
                        </button>
                        <button class="ticket-menu-option delete-btn">
                            <i class="bx bx-trash"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            <% } %>

            <div class="ticket-info">
              <div class="ticket-status-select-wrapper">
                <% if (user && ticket.user_id && ticket.user_id._id.toString() === user._id.toString()) { %>
                  <select id="status" name="status" class="ticket-status-select <%= ticket.status.replace(' ', '-').toLowerCase() %>">
                    <option value="abierto" <%= ticket.status === 'abierto' ? 'selected' : '' %>>🟢 Abierto</option>
                    <option value="en proceso" <%= ticket.status === 'en proceso' ? 'selected' : '' %>>🟡 En proceso</option>
                    <option value="cerrado" <%= ticket.status === 'cerrado' ? 'selected' : '' %>>🔴 Cerrado</option>
                  </select>
                <% } else { %>
                  <span class="ticket-status-text <%= ticket.status.replace(' ', '-').toLowerCase() %>">
                    <% if (ticket.status === 'abierto') { %>🟢 ABIERTO<% } %>
                    <% if (ticket.status === 'en proceso') { %>🟡 EN PROCESO<% } %>
                    <% if (ticket.status === 'cerrado') { %>🔴 CERRADO<% } %>
                  </span>
                <% } %>
              </div>
              <span class="badge <%= ticket.status.replace(' ', '-') %>" style="display:none;">
                  <%= ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) %>
              </span>
                <% if (user && ticket.user_id && ticket.user_id._id == user._id) { %>
                    <h3 class="view-mode"><%= ticket.title %></h3>
                    <p class="view-mode"><%= ticket.description %></p>

                    <input type="text" name="title" value="<%= ticket.title %>" class="edit-mode hidden-input" required />
                    <textarea name="description" class="edit-mode hidden-input" required><%= ticket.description %></textarea>

                    <button type="button" class="save-btn hidden-input">Guardar</button>
                    <button type="button" class="cancel-btn hidden-input">Cancelar</button>
                <% } else { %>
                    <h3><%= ticket.title %></h3>
                    <p><%= ticket.description %></p>
                <% } %>
                
                <span class="fecha">Fecha de creación: <%= new Date(ticket.date).toLocaleDateString('es-CR', { day: 'numeric', month: 'long', year: 'numeric' }) %></span>
              
                <div class="autor">
                  <div class="avatar">
                    <% if (ticket.user_id && ticket.user_id.avatar && ticket.user_id.avatar.length > 2) { %>
                      <img src="<%= ticket.user_id.avatar %>" alt="Avatar" />
                    <% } else if (ticket.user_id) { %>
                      <%= (ticket.user_id.name?.charAt(0) || '') + (ticket.user_id.last_names?.charAt(0) || '') %>
                    <% } else { %>
                      ?
                    <% } %>
                  </div>
                  <span>Reportado por: <%= ticket.user_id ? (ticket.user_id.name + ' ' + ticket.user_id.last_names) : 'Desconocido' %></span>
                </div>

                <% if (ticket.messages.length > 0) { %>
                    <div class="message-thread">
                    <% ticket.messages.forEach(msg => { %>
                        <div class="message <%= msg.sender_role?.toLowerCase() === 'administrador' ? 'admin-message' : 'user-message' %>">
                        <div class="message-content"><%- msg.message %></div>
                        <span class="message-meta">
                            <%= msg.sender_role?.toLowerCase() === 'administrador'
                            ? 'Admin'
                            : ((msg.user_id?.name || '') + ' ' + (msg.user_id?.last_names || '')).trim() || 'Usuario' 
                            %>
                            - <%= new Date(msg.timestamp).toLocaleDateString('es-CR', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                        </span>
                        </div>
                    <% }) %>
                    </div>
                <% } %>

                <% if (user && ticket.user_id && ticket.user_id._id == user._id) { %>
                    <button type="button" class="btn-reply-toggle">Enviar mensaje</button>
                <% } %>

                <form class="reply-form" style="display:none;">
                    <textarea name="message" placeholder="Escribe tu mensaje aquí..." rows="3" required></textarea>
                    <div class="reply-buttons">
                    <button type="button" class="btn-cancel">Cancelar</button>
                    <button type="submit" class="btn-send">Enviar</button>
                    </div>
                </form>
            </div>
          </div>
        <% }) %>

        <div class="create-ticket-cta">
          <a href="/form/form-tiquete" class="cta-button">
            <i class="bx bxs-plus-circle"></i>
            Crear un nuevo tiquete de soporte
          </a>
        </div>
      </div>
    <% } %>
  </main>

  <div id="custom-confirm" class="custom-alert hidden">
    <div class="alert-content">
      <p id="confirm-message"></p>
      <div class="confirm-buttons">
        <button id="confirm-no">No</button>
        <button id="confirm-yes">Sí</button>
      </div>
    </div>
  </div>

  <script>
    window.currentUserId = "<%= user ? user._id.toString() : '' %>";
  </script>
  <script src="/js/validateTicketState.js"></script>
  <script src="/js/filterContent.js"></script>
  <script src="/js/validateTicketMessage.js"></script>
  <script src="/js/ticketOptionsPopUp.js"></script>
</body>